name: smith
services:
  api:
    build:
      context: .
      dockerfile: api/api-dev.Dockerfile
    container_name: smith-api
    env_file:
      - .env
    ports:
      - "8080:8080"
    volumes:
      # Mount source code for hot reloading
      - ./api:/app/api
      - ./cli:/app/cli
      - ./models:/app/models
      - ./smithd:/app/smithd
      # Cache cargo registry and build artifacts for faster rebuilds
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/app/target
    networks:
      - backend
      - device-network
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    container_name: smith-postgres
    image: postgres:15
    env_file:
      - .env
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  bore:
    image: ekzhang/bore
    container_name: smith-bore
    command: server --min-port 30000 --max-port 30100
    ports:
      - "7835:7835"
      - "30000-30100:30000-30100"
    networks:
      - backend
      - device-network

  device:
    build:
      context: .
      dockerfile: smithd/device.Dockerfile
      args:
        # Override with ubuntu:22.04 for x86_64 Linux development
        BASE_IMAGE: ${DEVICE_BASE_IMAGE:-nvcr.io/nvidia/l4t-base:r36.2.0}
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    environment:
      - RUST_LOG=INFO
    networks:
      - device-network
    depends_on:
      - api
      - bore

  dashboard:
    build:
      context: ./dashboard
      dockerfile: dashboard-dev.Dockerfile
    container_name: smith-dashboard
    env_file:
      - ./dashboard/.env
    ports:
      - "3000:3000"
    volumes:
      # Mount source code for hot reloading
      - ./dashboard:/app
      # Cache node_modules for faster rebuilds
      - node_modules-cache:/app/node_modules
    networks:
      - backend
    depends_on:
      - api

networks:
  backend:
  device-network:
    # Simulates limited network on devices.
    internal: true

volumes:
  cargo-registry:
  cargo-git:
  target-cache:
  postgres-data:
  node_modules-cache:
