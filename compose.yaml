name: smith
services:
  api:
    build:
      context: .
      dockerfile: api/dev.Dockerfile
    container_name: smith-api
    cap_add:
      - NET_ADMIN
    env_file:
      - .env
    environment:
      - GLOBAL_BANDWIDTH_LIMIT=${GLOBAL_BANDWIDTH_LIMIT:-100}
    ports:
      - "8080:8080"
    volumes:
      # Mount source code for hot reloading
      - ./api:/app/api
      - ./cli:/app/cli
      - ./models:/app/models
      - ./smithd:/app/smithd
      # Cache cargo registry and build artifacts for faster rebuilds
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/app/target
      - ./scripts/api-throttle.sh:/app/api-throttle.sh:ro
    networks:
      - backend
      - device-network
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    container_name: smith-postgres
    image: postgres:15
    env_file:
      - .env
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  bore:
    image: ekzhang/bore
    container_name: smith-bore
    command: server --min-port 30000 --max-port 30100
    ports:
      - "7835:7835"
      - "30000-30100:30000-30100"
    networks:
      - backend
      - device-network

  device:
    build:
      context: .
      dockerfile: smithd/dev.Dockerfile
      args:
        # Override with ubuntu:22.04 for x86_64 Linux development
        BASE_IMAGE: ${DEVICE_BASE_IMAGE:-nvcr.io/nvidia/l4t-base:r36.2.0}
    privileged: true
    cap_add:
      - NET_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ./scripts/network-throttle.sh:/app/network-throttle.sh:ro
    environment:
      - RUST_LOG=INFO
      - NETWORK_THROTTLE=${NETWORK_THROTTLE:-random}
    entrypoint: ["/bin/bash", "-c", "/app/network-throttle.sh && exec /lib/systemd/systemd"]
    deploy:
      replicas: ${DEVICE_REPLICAS:-1}
    networks:
      - device-network
    depends_on:
      - api
      - bore

  dashboard:
    build:
      context: ./dashboard
      dockerfile: dev.Dockerfile
    container_name: smith-dashboard
    ports:
      - "3000:3000"
    volumes:
      # Mount source code for hot reloading
      - ./dashboard:/app
      # Cache node_modules for faster rebuilds
      - node_modules-cache:/app/node_modules
    networks:
      - backend
    depends_on:
      - api

networks:
  backend:
  device-network:
    # Simulates limited network on devices.
    internal: true

volumes:
  cargo-registry:
  cargo-git:
  target-cache:
  postgres-data:
  node_modules-cache:
