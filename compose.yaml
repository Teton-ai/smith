name: smith
services:
  api:
    build:
      context: .
      dockerfile: api.Dockerfile
    container_name: smith-api
    env_file:
      - .env
    ports:
      - "8080:8080"
    volumes:
      # Mount source code for hot reloading
      - ./api:/app/api
      - ./models:/app/models
      - ./smithd:/app/smithd
      # Cache cargo registry and build artifacts for faster rebuilds
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/app/target
    depends_on:
      - postgres

  postgres:
    container_name: smith-postgres
    build:
      dockerfile: postgres.Dockerfile
    env_file:
      - .env
    ports:
      - "5432:5432"

  bore:
    image: ekzhang/bore
    container_name: smith-bore
    command: server --min-port 30000 --max-port 30100
    ports:
      - "7835:7835"
      - "30000-30100:30000-30100"

  device:
    build:
      context: .
      dockerfile: device.Dockerfile
    container_name: smith-device
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - device-data:/etc/smith
    environment:
      - RUST_LOG=INFO
    depends_on:
      - api
      - bore

volumes:
  device-data:
  cargo-registry:
  cargo-git:
  target-cache:
